<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æœƒå“¡ä¸­å¿ƒ | æ˜¥æ Chun-Zhi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Noto Serif TC', serif;
    }
  </style>
</head>
<body class="bg-[#fdfaf5] text-[#1a1a1a] min-h-screen flex flex-col items-center px-4 py-10">

  <div class="w-full max-w-5xl bg-white rounded-xl shadow p-8 flex flex-col md:flex-row gap-8">
    
    <!-- å´é‚Šé¸å–® -->
    <aside class="w-full md:w-1/4 space-y-4 text-sm">
      <a href="/me.html" class="block hover:text-green-700">æœƒå“¡ä¸­å¿ƒ</a>
      <a href="/orders.html" class="block hover:text-green-700">æˆ‘çš„è¨‚å–®</a>
      <a href="/logout" class="block hover:text-green-700">ç™»å‡º</a>
    </aside>

    <!-- ä¸»å€å¡Š -->
    <main class="w-full md:w-3/4 space-y-6 text-sm">
      <h1 class="text-xl font-bold mb-2">æœƒå“¡ä¸­å¿ƒ</h1>
      
      <!-- æœƒå“¡è³‡è¨Š -->
      <div class="space-y-4">
        <div>
          <p><span class="font-semibold">å§“åï¼š</span><span id="name">è¼‰å…¥ä¸­...</span></p>
          <button id="edit-name" class="mt-1 text-green-700 hover:underline text-xs">æ›´æ–°æœƒå“¡åç¨±</button>
        </div>
        <div>
          <p><span class="font-semibold">Emailï¼š</span><span id="email">è¼‰å…¥ä¸­...</span></p>
        </div>
        <div>
          <p><span class="font-semibold">æ”¶ä»¶åœ°å€ï¼š</span><span id="address">å°šæœªè¨­å®š</span></p>
          <button id="edit-address" class="mt-1 text-green-700 hover:underline text-xs">æ›´æ–°æ”¶ä»¶åœ°å€</button>
        </div>
      </div>

      <!-- ç™»å…¥ç¶å®š -->
      <div class="pt-4 border-t">
        <h2 class="font-bold mb-2">ç™»å…¥ç¶å®š</h2>
        <p>LINE å¸³è™Ÿï¼š<span id="line-status">è¼‰å…¥ä¸­...</span></p>
        <p>Facebook å¸³è™Ÿï¼š<span id="fb-status">è¼‰å…¥ä¸­...</span></p>
      </div>

      <!-- ç‰©æµæŸ¥è©¢ -->
      <div class="pt-6 border-t">
        <h2 class="font-bold mb-3">ğŸ“¦ æˆ‘çš„ç‰©æµè³‡è¨Š</h2>
        <div id="order-logistics" class="text-sm text-gray-700 space-y-4">
          <p>è¼‰å…¥ä¸­...</p>
        </div>
      </div>
    </main>
  </div>

  <footer class="text-xs text-gray-500 mt-8 text-center">
    <p>Â© 2025 æ˜¥æ CHUN-ZHI</p>
    <p>support@chunzhi.comï½œ@chunzhi_care</p>
  </footer>

  <script>
    // å–å¾—æœƒå“¡è³‡æ–™
    fetch('/me')
      .then(res => res.json())
      .then(data => {
        if (!data.name) return window.location.href = '/login.html';

        document.getElementById('name').textContent = data.name || 'æœªæä¾›';
        document.getElementById('email').textContent = data.email || 'æœªæä¾›';
        document.getElementById('address').textContent = data.address || 'å°šæœªè¨­å®š';

        // ç™»å…¥ä¾†æºé¡¯ç¤º
        if (data.source === 'line') {
          document.getElementById('line-status').textContent = 'å·²ç¶å®š';
          document.getElementById('fb-status').innerHTML = 'å°šæœªç¶å®š <a href="/auth/facebook" class="ml-2 text-green-700 hover:underline">ç«‹å³ç¶å®š</a>';
        } else if (data.source === 'facebook') {
          document.getElementById('fb-status').textContent = 'å·²ç¶å®š';
          document.getElementById('line-status').innerHTML = 'å°šæœªç¶å®š <a href="/auth/line" class="ml-2 text-green-700 hover:underline">ç«‹å³ç¶å®š</a>';
        } else {
          document.getElementById('fb-status').innerHTML = 'å°šæœªç¶å®š <a href="/auth/facebook" class="ml-2 text-green-700 hover:underline">ç«‹å³ç¶å®š</a>';
          document.getElementById('line-status').innerHTML = 'å°šæœªç¶å®š <a href="/auth/line" class="ml-2 text-green-700 hover:underline">ç«‹å³ç¶å®š</a>';
        }
      })
      .catch(() => window.location.href = '/login.html');

    // ç·¨è¼¯å§“åèˆ‡åœ°å€
    document.getElementById('edit-name').onclick = () => {
      const newName = prompt('è«‹è¼¸å…¥æ–°çš„æœƒå“¡åç¨±ï¼š');
      if (newName) {
        fetch('/update-profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: newName })
        }).then(() => location.reload());
      }
    };

    document.getElementById('edit-address').onclick = () => {
      const newAddr = prompt('è«‹è¼¸å…¥æ–°çš„æ”¶ä»¶åœ°å€ï¼š');
      if (newAddr) {
        fetch('/update-address', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ address: newAddr })
        }).then(() => location.reload());
      }
    };

    // å–å¾—ç‰©æµè³‡è¨Š
    fetch('/api/orders')
      .then(res => res.json())
      .then(orders => {
        const container = document.getElementById('order-logistics');
        if (!orders.length) return container.innerHTML = '<p>ç›®å‰æ²’æœ‰ç‰©æµè³‡è¨Šã€‚</p>';

        container.innerHTML = orders.map(order => {
          const lid = order.logistics_id || 'â€”';
          const code = order.payment_no || 'â€”';
          const type = order.logistics_subtype || 'â€”';

          let queryLink = '';
          if (order.logistics_id) {
            queryLink = `<a href="/api/logistics/status/${lid}" target="_blank" class="ml-2 text-blue-600 hover:underline">æŸ¥è©¢</a>`;
          }

          return `
            <div class="border p-4 rounded bg-gray-50">
              <p><strong>è¨‚å–®æ™‚é–“ï¼š</strong>${new Date(order.created_at).toLocaleString()}</p>
              <p><strong>ç‰©æµå–®è™Ÿï¼š</strong>${lid}</p>
              <p><strong>å¯„ä»¶ä»£ç¢¼ï¼š</strong>${code}</p>
              <p><strong>è¶…å•†é¡å‹ï¼š</strong>${type}</p>
              <p><strong>ç‰©æµæŸ¥è©¢ï¼š</strong>${queryLink || 'â€”'}</p>
            </div>
          `;
        }).join('');
      })
      .catch(() => {
        document.getElementById('order-logistics').innerHTML = '<p class="text-red-600">âŒ ç„¡æ³•å–å¾—ç‰©æµè³‡è¨Šï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>';
      });
  </script>
</body>
</html>