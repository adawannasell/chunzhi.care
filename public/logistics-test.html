<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>物流訂單建立</title>
  <style>
    body { font-family: sans-serif; padding: 20px; line-height: 1.6; }
    input { margin: 6px 0; padding: 6px; width: 100%; max-width: 400px; }
    button { padding: 8px 16px; }
    .success { color: green; margin-top: 20px; }
    .error { color: red; margin-top: 20px; }
  </style>
</head>
<body>
  <h2>📦 建立物流訂單</h2>

  <!-- 📍 選擇門市（開啟綠界選店地圖） -->
  <form method="POST" action="/api/logistics/cvs-map" target="_blank">
    <button type="submit">📍 選擇門市</button>
  </form>

  <p id="selectedStore" style="font-weight: bold;"></p>

  <hr />

  <!-- 📝 AJAX 訂單建立表單 -->
  <form id="logisticsForm">
    <input name="name" placeholder="收件人姓名 (中文2~5字)" required />
    <input name="phone" placeholder="手機號碼" pattern="09[0-9]{8}" required />
    <input name="storeID" id="storeID" placeholder="門市代碼" required />
    <input name="itemName" placeholder="商品名稱" value="雪Q餅" required />
    <input name="total" placeholder="金額" value="399" required />
    <button type="submit">✅ 送出物流訂單</button>
  </form>

  <div id="message"></div>

  <script>
    const params = new URLSearchParams(location.search);
    const storeID = params.get('storeID');
    const storeName = params.get('storeName');

    if (storeID) {
      document.getElementById('storeID').value = storeID;
      document.getElementById('selectedStore').textContent =
        `已選擇門市 ➜ ${storeName || ''}（代碼：${storeID}）`;
    }

    document.getElementById('logisticsForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const data = Object.fromEntries(new FormData(form));
      const messageDiv = document.getElementById('message');
      messageDiv.textContent = '📡 傳送中...';

      try {
        const res = await fetch('/api/logistics/create-order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        const html = await res.text();
        if (res.ok) {
          messageDiv.className = 'success';
          messageDiv.innerHTML = '✅ 訂單已送出，請查看畫面下方跳出的物流畫面';
          const w = window.open();
          w.document.write(html);
        } else {
          messageDiv.className = 'error';
          messageDiv.textContent = '🚨 發生錯誤：' + html;
        }
      } catch (err) {
        messageDiv.className = 'error';
        messageDiv.textContent = '🚨 系統錯誤：' + err.message;
      }
    });
  </script>
</body>
</html>