<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ç‰©æµè¨‚å–®å»ºç«‹</title>
  <style>
    body { font-family: sans-serif; padding: 20px; line-height: 1.6; }
    input { margin: 6px 0; padding: 6px; width: 100%; max-width: 400px; }
    button { padding: 8px 16px; }
    .success { color: green; margin-top: 20px; }
    .error { color: red; margin-top: 20px; }
  </style>
</head>
<body>
  <h2>ğŸ“¦ å»ºç«‹ç‰©æµè¨‚å–®</h2>

  <!-- ğŸ“ é¸æ“‡é–€å¸‚ï¼ˆé–‹å•Ÿç¶ ç•Œé¸åº—åœ°åœ–ï¼‰ -->
  <form method="POST" action="/api/logistics/cvs-map" target="_blank">
    <button type="submit">ğŸ“ é¸æ“‡é–€å¸‚</button>
  </form>

  <p id="selectedStore" style="font-weight: bold;"></p>

  <hr />

  <!-- ğŸ“ AJAX è¨‚å–®å»ºç«‹è¡¨å–® -->
  <form id="logisticsForm">
    <input name="name" placeholder="æ”¶ä»¶äººå§“å (ä¸­æ–‡2~5å­—)" required />
    <input name="phone" placeholder="æ‰‹æ©Ÿè™Ÿç¢¼" pattern="09[0-9]{8}" required />
    <input name="storeID" id="storeID" placeholder="é–€å¸‚ä»£ç¢¼" required />
    <input name="itemName" placeholder="å•†å“åç¨±" value="é›ªQé¤…" required />
    <input name="total" placeholder="é‡‘é¡" value="399" required />
    <button type="submit">âœ… é€å‡ºç‰©æµè¨‚å–®</button>
  </form>

  <div id="message"></div>

  <script>
    const params = new URLSearchParams(location.search);
    const storeID = params.get('storeID');
    const storeName = params.get('storeName');

    if (storeID) {
      document.getElementById('storeID').value = storeID;
      document.getElementById('selectedStore').textContent =
        `å·²é¸æ“‡é–€å¸‚ âœ ${storeName || ''}ï¼ˆä»£ç¢¼ï¼š${storeID}ï¼‰`;
    }

    document.getElementById('logisticsForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const data = Object.fromEntries(new FormData(form));
      const messageDiv = document.getElementById('message');
      messageDiv.textContent = 'ğŸ“¡ å‚³é€ä¸­...';

      try {
        const res = await fetch('/api/logistics/create-order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        const html = await res.text();
        if (res.ok) {
          messageDiv.className = 'success';
          messageDiv.innerHTML = 'âœ… è¨‚å–®å·²é€å‡ºï¼Œè«‹æŸ¥çœ‹ç•«é¢ä¸‹æ–¹è·³å‡ºçš„ç‰©æµç•«é¢';
          const w = window.open();
          w.document.write(html);
        } else {
          messageDiv.className = 'error';
          messageDiv.textContent = 'ğŸš¨ ç™¼ç”ŸéŒ¯èª¤ï¼š' + html;
        }
      } catch (err) {
        messageDiv.className = 'error';
        messageDiv.textContent = 'ğŸš¨ ç³»çµ±éŒ¯èª¤ï¼š' + err.message;
      }
    });
  </script>
</body>
</html>